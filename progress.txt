# Ralph Progress Log
Started: Tue Feb 17 09:14:02 PM GMT 2026

## Codebase Patterns
- **Error codes in backends:** `FileOperationError` in `backends/protocol.py` is a `Literal` type — add new error codes there. Both `StateBackend` and `FilesystemBackend` must be updated in tandem. The tool layer in `tools/filesystem.py` maps error codes to user-facing messages.
- **Async overrides pattern:** `StateBackend` overrides async methods with direct sync calls (no `asyncio.to_thread`) since it's in-memory. `FilesystemBackend` inherits the default `asyncio.to_thread` wrappers from the ABC. When adding a new backend, decide based on whether operations involve I/O.
- **Test structure:** Backend tests are in `tests/unit_tests/backends/test_<backend>_backend.py`, tool tests in `tests/unit_tests/tools/test_filesystem_tools.py`. Tests assert specific error codes, not just `is not None`.
- **Write is create-only:** `Backend.write()` is create-only (no overwrites). Use `edit()` for modifications.
---

## 2026-02-17 - US-001
Thread: https://ampcode.com/threads/T-019c6d73-fbc5-70ac-886b-a5dc2830f757
- Added `"already_exists"` to `FileOperationError` Literal type in `backends/protocol.py`
- Changed `StateBackend.write()` to return `error="already_exists"` instead of `"invalid_path"` when file exists
- Changed `FilesystemBackend.write()` to return `error="already_exists"` instead of `"invalid_path"` when file exists
- Updated `tools/filesystem.py` to check for `"already_exists"` error code
- Updated tests in `test_state_backend.py` and `test_filesystem_backend.py` to assert `error == "already_exists"`
- Files changed: `backends/protocol.py`, `backends/state.py`, `backends/filesystem.py`, `tools/filesystem.py`, `test_state_backend.py`, `test_filesystem_backend.py`
- **Learnings for future iterations:**
  - `FileOperationError` is a `Literal` union — keep it in sync across all backends
  - `FilesystemBackend.write()` has two `invalid_path` returns: one for path resolution failure, one for file-already-exists — only the latter was changed
  - The tool layer in `tools/filesystem.py` already had the right user message ("File already exists"), just needed the error code check updated
---

## 2026-02-17 - US-002
Thread: https://ampcode.com/threads/T-019c6d75-77a0-7389-8546-75f7a90e8510
- Changed `graph.py` to check `import adk_skills_agent` directly before calling `add_skills_tools()` when `skills` is provided
- When import fails and skills are requested, raises `ImportError` with clear install instructions
- When skills are NOT requested, the import is never attempted (existing `if skills:` guard)
- `integration.py` unchanged — it still logs a warning internally, but `graph.py` now gates before it
- Added 2 tests to `test_graph.py`: one for the error case, one for the no-error case
- Files changed: `adk_deepagents/graph.py`, `tests/unit_tests/test_graph.py`
- **Learnings for future iterations:**
  - `integration.py` has its own `try/except ImportError` that catches silently — the gate must happen in `graph.py` before calling into integration
  - Use `from None` on re-raised `ImportError` to satisfy ruff B904
  - Ruff SIM117 requires combining nested `with` statements into a single `with` using `,`
---

## 2026-02-17 - US-003
Thread: https://ampcode.com/threads/T-019c6d77-937b-74b1-8185-46ad542e12b1
- Added `context_window: int | None` field to `SummarizationConfig` in `types.py`
- Rewrote `_resolve_context_window()` in `callbacks/before_model.py` with 3-tier resolution: explicit config → model lookup table → DEFAULT_CONTEXT_WINDOW fallback
- Added `MODEL_CONTEXT_WINDOWS` dict with known model context sizes (Gemini, GPT-4o, Claude-3)
- Added 5 unit tests covering: explicit config, known models, unknown models, override precedence, and defaults
- Files changed: `adk_deepagents/types.py`, `adk_deepagents/callbacks/before_model.py`, `tests/unit_tests/callbacks/test_before_model.py`
- **Learnings for future iterations:**
  - `_resolve_context_window` is in `callbacks/before_model.py`, not in `summarization.py` — the callback module resolves config into concrete values before passing to `maybe_summarize()`
  - Trigger/keep resolution functions (`_resolve_trigger_fraction`, `_resolve_keep_messages`) live alongside `_resolve_context_window` in the same file
  - The `maybe_summarize()` function takes already-resolved numeric values, not the config object
---

## 2026-02-17 - US-004
Thread: https://ampcode.com/threads/T-019c6d79-786c-725d-b0b5-b9a0379a08d5
- Added 6 async methods to `Backend` ABC in `backends/protocol.py`: `als_info`, `aread`, `awrite`, `aedit`, `agrep_raw`, `aglob_info`
- Default implementations wrap sync methods via `asyncio.to_thread()`
- Added 7 async unit tests in `tests/unit_tests/backends/test_protocol.py` verifying async methods match sync results on StateBackend
- Files changed: `adk_deepagents/backends/protocol.py`, `tests/unit_tests/backends/test_protocol.py`
- **Learnings for future iterations:**
  - `StateBackend.edit()` returns `files_update` dict but doesn't auto-apply it to `_state["files"]` — tests that chain edits must manually apply updates
  - Async tests run automatically via `pytest-asyncio` with `asyncio_mode = "auto"` — no `@pytest.mark.asyncio` decorator needed
  - `ruff format` may reformat multi-line `asyncio.to_thread()` calls — run format check before committing
---

## 2026-02-17 - US-005
Thread: https://ampcode.com/threads/T-019c6d7b-661a-77cf-87f7-0242e957913e
- Added 6 async method overrides to `StateBackend` in `backends/state.py`: `als_info`, `aread`, `awrite`, `aedit`, `agrep_raw`, `aglob_info`
- Each override directly calls the sync method (no `asyncio.to_thread`) since StateBackend is in-memory
- Added 12 async unit tests in `test_state_backend.py` including a `test_no_asyncio_to_thread` that monkeypatches `asyncio.to_thread` to verify it's never called
- Files changed: `adk_deepagents/backends/state.py`, `tests/unit_tests/backends/test_state_backend.py`
- **Learnings for future iterations:**
  - StateBackend async overrides are trivial — just call the sync method directly since there's no I/O
  - The `monkeypatch` approach for verifying no `asyncio.to_thread` usage is effective — patch the function and assert it was never called
  - All 6 async methods have matching signatures to the ABC defaults in `protocol.py`
---
