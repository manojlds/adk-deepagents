# Ralph Progress Log
Started: Tue Feb 17 09:14:02 PM GMT 2026

## Codebase Patterns
- **Error codes in backends:** `FileOperationError` in `backends/protocol.py` is a `Literal` type — add new error codes there. Both `StateBackend` and `FilesystemBackend` must be updated in tandem. The tool layer in `tools/filesystem.py` maps error codes to user-facing messages.
- **Async overrides pattern:** `StateBackend` overrides async methods with direct sync calls (no `asyncio.to_thread`) since it's in-memory. `FilesystemBackend` inherits the default `asyncio.to_thread` wrappers from the ABC. When adding a new backend, decide based on whether operations involve I/O.
- **Test structure:** Backend tests are in `tests/unit_tests/backends/test_<backend>_backend.py`, tool tests in `tests/unit_tests/tools/test_filesystem_tools.py`. Tests assert specific error codes, not just `is not None`.
- **Write is create-only:** `Backend.write()` is create-only (no overwrites). Use `edit()` for modifications.
- **StoreBackend namespace pattern:** `StoreBackend` uses `_ns_path()` / `_strip_ns()` to transparently prefix/strip namespace from paths. For grep/glob utilities, remap files to external paths before calling shared helpers.
- **HITL via ADK ToolConfirmation:** Use `tool_context.request_confirmation()` to pause the agent. Check `tool_context.tool_confirmation` on resume: `None` = first call (pause), `.confirmed=True` = approved, `.confirmed=False` = rejected. Use `payload` dict for `modified_args`. Always set `actions.skip_summarization = True` when requesting confirmation.
- **SubAgentSpec supports LlmAgent instances:** The `subagents` list in `create_deep_agent()` accepts both `SubAgentSpec` dicts and pre-built `LlmAgent` instances. `build_subagent_tools()` separates them: pre-built agents become `AgentTool` directly, specs are built as before. When checking for general_purpose, both pre-built names and spec names are considered.
---

## 2026-02-17 - US-001
Thread: https://ampcode.com/threads/T-019c6d73-fbc5-70ac-886b-a5dc2830f757
- Added `"already_exists"` to `FileOperationError` Literal type in `backends/protocol.py`
- Changed `StateBackend.write()` to return `error="already_exists"` instead of `"invalid_path"` when file exists
- Changed `FilesystemBackend.write()` to return `error="already_exists"` instead of `"invalid_path"` when file exists
- Updated `tools/filesystem.py` to check for `"already_exists"` error code
- Updated tests in `test_state_backend.py` and `test_filesystem_backend.py` to assert `error == "already_exists"`
- Files changed: `backends/protocol.py`, `backends/state.py`, `backends/filesystem.py`, `tools/filesystem.py`, `test_state_backend.py`, `test_filesystem_backend.py`
- **Learnings for future iterations:**
  - `FileOperationError` is a `Literal` union — keep it in sync across all backends
  - `FilesystemBackend.write()` has two `invalid_path` returns: one for path resolution failure, one for file-already-exists — only the latter was changed
  - The tool layer in `tools/filesystem.py` already had the right user message ("File already exists"), just needed the error code check updated
---

## 2026-02-17 - US-002
Thread: https://ampcode.com/threads/T-019c6d75-77a0-7389-8546-75f7a90e8510
- Changed `graph.py` to check `import adk_skills_agent` directly before calling `add_skills_tools()` when `skills` is provided
- When import fails and skills are requested, raises `ImportError` with clear install instructions
- When skills are NOT requested, the import is never attempted (existing `if skills:` guard)
- `integration.py` unchanged — it still logs a warning internally, but `graph.py` now gates before it
- Added 2 tests to `test_graph.py`: one for the error case, one for the no-error case
- Files changed: `adk_deepagents/graph.py`, `tests/unit_tests/test_graph.py`
- **Learnings for future iterations:**
  - `integration.py` has its own `try/except ImportError` that catches silently — the gate must happen in `graph.py` before calling into integration
  - Use `from None` on re-raised `ImportError` to satisfy ruff B904
  - Ruff SIM117 requires combining nested `with` statements into a single `with` using `,`
---

## 2026-02-17 - US-003
Thread: https://ampcode.com/threads/T-019c6d77-937b-74b1-8185-46ad542e12b1
- Added `context_window: int | None` field to `SummarizationConfig` in `types.py`
- Rewrote `_resolve_context_window()` in `callbacks/before_model.py` with 3-tier resolution: explicit config → model lookup table → DEFAULT_CONTEXT_WINDOW fallback
- Added `MODEL_CONTEXT_WINDOWS` dict with known model context sizes (Gemini, GPT-4o, Claude-3)
- Added 5 unit tests covering: explicit config, known models, unknown models, override precedence, and defaults
- Files changed: `adk_deepagents/types.py`, `adk_deepagents/callbacks/before_model.py`, `tests/unit_tests/callbacks/test_before_model.py`
- **Learnings for future iterations:**
  - `_resolve_context_window` is in `callbacks/before_model.py`, not in `summarization.py` — the callback module resolves config into concrete values before passing to `maybe_summarize()`
  - Trigger/keep resolution functions (`_resolve_trigger_fraction`, `_resolve_keep_messages`) live alongside `_resolve_context_window` in the same file
  - The `maybe_summarize()` function takes already-resolved numeric values, not the config object
---

## 2026-02-17 - US-004
Thread: https://ampcode.com/threads/T-019c6d79-786c-725d-b0b5-b9a0379a08d5
- Added 6 async methods to `Backend` ABC in `backends/protocol.py`: `als_info`, `aread`, `awrite`, `aedit`, `agrep_raw`, `aglob_info`
- Default implementations wrap sync methods via `asyncio.to_thread()`
- Added 7 async unit tests in `tests/unit_tests/backends/test_protocol.py` verifying async methods match sync results on StateBackend
- Files changed: `adk_deepagents/backends/protocol.py`, `tests/unit_tests/backends/test_protocol.py`
- **Learnings for future iterations:**
  - `StateBackend.edit()` returns `files_update` dict but doesn't auto-apply it to `_state["files"]` — tests that chain edits must manually apply updates
  - Async tests run automatically via `pytest-asyncio` with `asyncio_mode = "auto"` — no `@pytest.mark.asyncio` decorator needed
  - `ruff format` may reformat multi-line `asyncio.to_thread()` calls — run format check before committing
---

## 2026-02-17 - US-005
Thread: https://ampcode.com/threads/T-019c6d7b-661a-77cf-87f7-0242e957913e
- Added 6 async method overrides to `StateBackend` in `backends/state.py`: `als_info`, `aread`, `awrite`, `aedit`, `agrep_raw`, `aglob_info`
- Each override directly calls the sync method (no `asyncio.to_thread`) since StateBackend is in-memory
- Added 12 async unit tests in `test_state_backend.py` including a `test_no_asyncio_to_thread` that monkeypatches `asyncio.to_thread` to verify it's never called
- Files changed: `adk_deepagents/backends/state.py`, `tests/unit_tests/backends/test_state_backend.py`
- **Learnings for future iterations:**
  - StateBackend async overrides are trivial — just call the sync method directly since there's no I/O
  - The `monkeypatch` approach for verifying no `asyncio.to_thread` usage is effective — patch the function and assert it was never called
  - All 6 async methods have matching signatures to the ABC defaults in `protocol.py`
---

## 2026-02-17 - US-006
Thread: https://ampcode.com/threads/T-019c6d7c-f700-743d-ba36-d7c67cb168b2
- Added 6 async method overrides to `CompositeBackend` in `backends/composite.py`: `als_info`, `aread`, `awrite`, `aedit`, `agrep_raw`, `aglob_info`
- Each override delegates to the resolved backend's async method (not the sync method)
- `agrep_raw` and `aglob_info` mirror the sync merge logic (multi-backend search + deduplication)
- `FilesystemBackend` inherits default `asyncio.to_thread()` wrappers from ABC — no changes needed
- Added 9 async unit tests including a mock-based test verifying delegation calls the async method on the child backend
- Files changed: `adk_deepagents/backends/composite.py`, `tests/unit_tests/backends/test_composite_backend.py`
- **Learnings for future iterations:**
  - `CompositeBackend` async methods must mirror the merge logic from sync counterparts for `agrep_raw` and `aglob_info`
  - `ruff format` rewrites multi-line async method argument lists — always run `ruff format --check` before commit
  - `AsyncMock` from `unittest.mock` works cleanly with `MagicMock(spec=Backend)` for verifying async delegation
---

## 2026-02-17 - US-007
Thread: https://ampcode.com/threads/T-019c6d7e-923b-7198-b35d-a4cbccf9cc08
- Created `StoreBackend` in `adk_deepagents/backends/store.py` — a cross-thread persistence backend using a shared dict-based store
- Implements full Backend ABC (ls, read, write, edit, grep, glob, upload, download) + all 6 async overrides (direct, no asyncio.to_thread)
- Supports namespace-based isolation: paths are transparently prefixed with `/<namespace>` in the store but presented without prefix to callers
- Cross-thread persistence: same `store` dict instance passed to multiple StoreBackend instances allows data sharing
- CompositeBackend routing works with StoreBackend via path prefix
- Exported `StoreBackend` from `adk_deepagents/backends/__init__.py`
- 42 unit tests in `tests/unit_tests/backends/test_store_backend.py` covering all operations, namespace isolation, cross-session reads, composite routing, and async methods
- Files changed: `adk_deepagents/backends/store.py` (new), `adk_deepagents/backends/__init__.py`, `tests/unit_tests/backends/test_store_backend.py` (new)
- **Learnings for future iterations:**
  - StoreBackend follows the same in-memory pattern as StateBackend — async overrides are direct sync calls, no `asyncio.to_thread`
  - Namespace isolation uses `_ns_path()` and `_strip_ns()` helpers to transparently map between external paths and internal namespaced paths
  - For grep/glob, files must be remapped to external paths before passing to shared utility functions (`grep_matches_from_files`, `glob_search_files`)
  - `ruff format` rewrites long docstrings and method signatures — always run `ruff format` before committing
  - Import sorting: `asyncio` (stdlib) must come before `pytest` (third-party) — `ruff check --fix` handles this
  ---

  ## 2026-02-17 - US-008
  Thread: https://ampcode.com/threads/T-019c6d81-6bc6-76ca-8245-77b1987cac4e
  - Added image detection to `read_file` in `tools/filesystem.py` for extensions `.png`, `.jpg`, `.jpeg`, `.gif`, `.webp`
  - Image files are read via `backend.download_files()` (binary read) and returned as base64-encoded dicts with `type`, `media_type`, and `data` keys
  - Non-image files continue through the existing text `backend.read()` path
  - Added 4 tests: PNG round-trip, JPEG media type, missing image error, non-image unchanged
  - Files changed: `adk_deepagents/tools/filesystem.py`, `tests/unit_tests/tools/test_filesystem_tools.py`
  - **Learnings for future iterations:**
  - `download_files()` returns `FileDownloadResponse` with `.content` as `bytes | None` and `.error` — use it for binary reads
  - Image detection uses `os.path.splitext` + a frozenset of extensions — simple and extensible
  - Mock `backend.download_files` directly on the backend instance from `mock_tool_context.state["_backend"]` for image tests
  - Always run `ruff format` after edits — ruff reformats spacing around `frozenset` and `dict` literals
  ---

  ## 2026-02-17 - US-010
  Thread: https://ampcode.com/threads/T-019c6d86-515e-767d-83ce-ba292f1a734e
  - Added `extra_callbacks: dict[str, Callable] | None = None` parameter to `create_deep_agent()` and `create_deep_agent_async()`
  - Added `_compose_callbacks()` helper in `graph.py` that composes built-in + extra: built-in runs first, extra runs second; short-circuit (non-None return) from built-in skips extra
  - Supported keys: `before_agent`, `before_model`, `before_tool`, `after_tool`
  - 13 unit tests covering: None/empty extra_callbacks, all 4 callback types, composition order, short-circuit behavior, None edge cases
  - Files changed: `adk_deepagents/graph.py`, `tests/unit_tests/test_graph.py`
  - **Learnings for future iterations:**
  - `make_before_tool_callback()` returns `None` when no `interrupt_on` is set — `_compose_callbacks(None, extra)` must handle this by returning extra directly
  - `ruff format` reformats multi-line keyword arguments in `_compose_callbacks` calls — always run format before committing
  - The composition pattern is generic (`*args, **kwargs`) so it works for all 4 callback signatures without needing type-specific wrappers
  ---

  ## 2026-02-17 - US-009
  Thread: https://ampcode.com/threads/T-019c6d83-225f-72c4-9743-28a6f38a184e
  - Rewrote `before_tool.py` to use ADK's native `tool_context.request_confirmation()` for true pause/resume instead of just setting state
  - First invocation: calls `request_confirmation()` with hint + payload (approval_id, tool, args), sets `skip_summarization=True`, returns `awaiting_approval` dict
  - Resume with `confirmed=True`: proceeds with tool execution; supports `modified_args` via `payload`
  - Resume with `confirmed=False`: returns rejection dict, skipping the tool
  - Added `resume_approval()` helper that creates a `ToolConfirmation` object for callers (CLI, web UI, tests)
  - Exported `resume_approval` from `callbacks/__init__.py`
  - 14 unit tests covering: no-interrupt, empty, all-false, unspecified tool, multiple tools, first-call pause, approve, reject, modified args, resume_approval helper
  - Files changed: `adk_deepagents/callbacks/before_tool.py`, `adk_deepagents/callbacks/__init__.py`, `tests/unit_tests/callbacks/test_before_tool.py`
  - **Learnings for future iterations:**
  - ADK has native HITL support via `ToolContext.request_confirmation()` and `ToolContext.tool_confirmation` — no need for custom exception/signal hacking
  - Pattern: first call has `tool_confirmation=None` → call `request_confirmation()`; second call has `ToolConfirmation` with `confirmed` and optional `payload`
  - `ToolConfirmation` is marked `@experimental(FeatureName.TOOL_CONFIRMATION)` — tests emit a UserWarning about experimental feature
  - `actions.skip_summarization = True` prevents ADK from summarizing the confirmation request as a tool response
  - The `payload` field on `ToolConfirmation` is `Any` (JSON serializable) — used to pass `modified_args` dict for the modified-args flow
  ---

## 2026-02-17 - US-011
Thread: https://ampcode.com/threads/T-019c6d88-9270-754a-b156-cdcaf456381f
- Added `skills: list[str]` and `interrupt_on: dict[str, bool]` optional fields to `SubAgentSpec` in `types.py`
- Updated `build_subagent_tools()` in `tools/task.py` to process `skills` (via `_resolve_skills_tools`) and `interrupt_on` (via `make_before_tool_callback`) per sub-agent
- Added support for pre-built `LlmAgent` instances in the `subagents` list — they pass through as `AgentTool` directly
- Updated `create_deep_agent()` in `graph.py` to handle `LlmAgent` instances in description building and pass `skills_config` to `build_subagent_tools`
- Added 8 unit tests: skills import error, no-skills no-error, interrupt_on callback, no-interrupt_on, pre-built agent, mixed list, pre-built GP dedup
- Files changed: `adk_deepagents/types.py`, `adk_deepagents/tools/task.py`, `adk_deepagents/graph.py`, `tests/unit_tests/test_graph.py`
- **Learnings for future iterations:**
  - `build_subagent_tools()` must separate pre-built `LlmAgent` from `SubAgentSpec` dicts at the start — `isinstance(item, LlmAgent)` check
  - Sub-agent skills use the same `ImportError` guard pattern as the parent — centralized in `_resolve_skills_tools()`
  - `ruff format` rewrites multi-line for-loops in graph.py — always run format before commit
  - General-purpose dedup must check both pre-built agent names and spec names
  ---

  ## 2026-02-17 - US-012
  Thread: https://ampcode.com/threads/T-019c6d8a-ee0b-70f4-9e86-ee0c15a69335
  - Added `litellm>=1.81.13` and `pytest-timeout>=2.0` to dev dependencies in `pyproject.toml`
  - Added `integration` marker definition to `[tool.pytest.ini_options]` in `pyproject.toml`
  - Created `tests/integration_tests/conftest.py` with auto-skip logic when `OPENCODE_API_KEY` is not set
  - Created `tests/integration_tests/test_filesystem_roundtrip.py` with full round-trip scenario: write_file → read_file → edit_file → verify content
  - Tests use `LiteLlm` from `google.adk.models.lite_llm` configured to hit OpenCode Zen endpoint (`https://opencode.ai/zen/v1/chat/completions`)
  - API key is read from `OPENCODE_API_KEY` environment variable
  - Tests marked with `@pytest.mark.integration` and `@pytest.mark.timeout(120)` for safety
  - Uses `InMemoryRunner` from `google.adk.runners` for end-to-end agent execution
  - Files changed: `pyproject.toml`, `tests/integration_tests/conftest.py` (new), `tests/integration_tests/test_filesystem_roundtrip.py` (new), `uv.lock`
  - **Learnings for future iterations:**
  - `_backend_factory` must be passed in initial session state for filesystem tools to work — callbacks use their own closure-captured factory but tools resolve from `tool_context.state`
  - `InMemoryRunner.session_service.create_session()` accepts `state` dict for initial session state
  - `LiteLlm(model="openai/gpt-4o-mini", api_key=..., api_base=...)` passes kwargs through to litellm completion API
  - Integration tests use multi-turn conversation within a single session: first `_run_agent()` helper for initial prompt, then `runner.run_async()` for subsequent turns
  - `conftest.py` `pytest_collection_modifyitems` hook is the cleanest way to skip all integration tests when the API key is missing
  - `ruff format` will reformat new files — always run format before committing
  ---

  ## 2026-02-17 - US-013
  Thread: https://ampcode.com/threads/T-019c6d8f-5ced-766d-9657-64aab67c471f
  - Created `tests/integration_tests/test_subagent_delegation.py` with sub-agent delegation scenario
  - Test creates a main agent with a `math_expert` sub-agent via `SubAgentSpec`, instructs the main agent to delegate a math question, and verifies the sub-agent computed the result (15×7=105)
  - Follows same patterns as `test_filesystem_roundtrip.py`: `_make_litellm_model()`, `_backend_factory()`, `_run_agent()` helper, `@pytest.mark.integration`, `@pytest.mark.timeout(120)`
  - Files changed: `tests/integration_tests/test_subagent_delegation.py` (new)
  - **Learnings for future iterations:**
  - Sub-agent delegation tests should use concrete, verifiable answers (e.g., math) so assertions can check exact values
  - The `SubAgentSpec` only needs `name` and `description` for basic delegation — `model` and `tools` default from the parent
  - Integration test helpers (`_run_agent`, `_make_litellm_model`, `_backend_factory`) are duplicated per test file since they're lightweight — could be shared via conftest if more tests are added
  ---
