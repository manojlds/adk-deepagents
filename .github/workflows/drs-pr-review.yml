name: DRS PR Review

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled]

jobs:
  verify-contributor:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      is-trusted: ${{ steps.check.outputs.is-trusted }}
      has-review-label: ${{ steps.check.outputs.has-review-label }}
    steps:
      - name: Check contributor status
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          AUTHOR="${{ github.event.pull_request.user.login }}"
          REPO="${{ github.repository }}"
          echo "Checking if $AUTHOR is a trusted contributor..."
          if gh api "/repos/$REPO/collaborators/$AUTHOR" --silent 2>/dev/null; then
            echo "is-trusted=true" >> $GITHUB_OUTPUT
          else
            echo "is-trusted=false" >> $GITHUB_OUTPUT
          fi
          LABELS='${{ toJSON(github.event.pull_request.labels.*.name) }}'
          if echo "$LABELS" | grep -q "safe-to-review"; then
            echo "has-review-label=true" >> $GITHUB_OUTPUT
          else
            echo "has-review-label=false" >> $GITHUB_OUTPUT
          fi

  review-trusted:
    runs-on: ubuntu-latest
    needs: verify-contributor
    if: needs.verify-contributor.outputs.is-trusted == 'true'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0
      - name: Fetch base branch for git diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}:refs/remotes/origin/${{ github.event.pull_request.base.ref }}
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install OpenCode CLI
        run: npm install -g opencode-ai
      - name: Install DRS
        run: npm install -g @diff-review-system/drs@2.2.1
      - name: Setup OpenCode Zen Authentication
        if: env.OPENCODE_ZEN_API_KEY != ''
        env:
          OPENCODE_ZEN_API_KEY: ${{ secrets.OPENCODE_ZEN_API_KEY }}
        run: |
          mkdir -p ~/.local/share/opencode
          cat > ~/.local/share/opencode/auth.json <<EOF
          {
            "opencode": {
              "type": "api",
              "key": "${OPENCODE_ZEN_API_KEY}"
            }
          }
          EOF
      - name: Review Pull Request (Trusted Contributor)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENCODE_ZEN_API_KEY: ${{ secrets.OPENCODE_ZEN_API_KEY }}
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          drs review-pr \
            --owner ${{ github.event.repository.owner.login }} \
            --repo ${{ github.event.repository.name }} \
            --pr ${{ github.event.pull_request.number }} \
            --post-comments \
            --debug

  review-external:
    runs-on: ubuntu-latest
    needs: verify-contributor
    if: |
      needs.verify-contributor.outputs.is-trusted == 'false' &&
      needs.verify-contributor.outputs.has-review-label == 'true'
    environment: external-pr-review
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0
      - name: Fetch base branch for git diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}:refs/remotes/origin/${{ github.event.pull_request.base.ref }}
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install OpenCode CLI
        run: npm install -g opencode-ai
      - name: Install DRS
        run: npm install -g @diff-review-system/drs@2.2.1
      - name: Setup OpenCode Zen Authentication
        if: env.OPENCODE_ZEN_API_KEY != ''
        env:
          OPENCODE_ZEN_API_KEY: ${{ secrets.OPENCODE_ZEN_API_KEY }}
        run: |
          mkdir -p ~/.local/share/opencode
          cat > ~/.local/share/opencode/auth.json <<EOF
          {
            "opencode": {
              "type": "api",
              "key": "${OPENCODE_ZEN_API_KEY}"
            }
          }
          EOF
      - name: Review Pull Request (External Contributor)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENCODE_ZEN_API_KEY: ${{ secrets.OPENCODE_ZEN_API_KEY }}
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          drs review-pr \
            --owner ${{ github.event.repository.owner.login }} \
            --repo ${{ github.event.repository.name }} \
            --pr ${{ github.event.pull_request.number }} \
            --post-comments \
            --debug

  notify-external:
    runs-on: ubuntu-latest
    needs: verify-contributor
    if: |
      needs.verify-contributor.outputs.is-trusted == 'false' &&
      needs.verify-contributor.outputs.has-review-label == 'false'
    permissions:
      pull-requests: write
    steps:
      - name: Post notification comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --body "ðŸ‘‹ Thanks for your contribution! A maintainer will review this PR and add the \`safe-to-review\` label to trigger an automated code review."
